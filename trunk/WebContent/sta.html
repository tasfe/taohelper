<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
 <script type="text/javascript" src="../script/comFunc.js"></script>
 <script type="text/javascript" src="jscharts.js"></script>
 <style type="text/css"> 
/* CSS Document */

	.mytable { 
	    width: 700px; 
	    padding: 0; 
	    margin: 0; 
	}
	
	.mytable caption { 
	    padding: 0 0 5px 0; 
	    width: 700px;      
	    font: italic 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif; 
	    text-align: right; 
	}
	
	.mytable th { 
	    font: bold 11px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif; 
	    color: #4f6b72; 
	    border-right: 1px solid #C1DAD7; 
	    border-bottom: 1px solid #C1DAD7; 
	    border-top: 1px solid #C1DAD7; 
	    letter-spacing: 2px; 
	    text-transform: uppercase; 
	    text-align: left; 
		text-align:center;
	    padding: 6px 6px 6px 12px; 
	    background: #CAE8EA url(images/bg_header.jpg) no-repeat; 
	}
	
	.mytable th.nobg { 
	    border-top: 0; 
	    border-left: 0; 
	    border-right: 1px solid #C1DAD7; 
	    background: none; 
	}
	
	.mytable td { 
	    border-right: 1px solid #C1DAD7; 
	    border-bottom: 1px solid #C1DAD7; 
	    background: #fff; 
	    font-size:11px; 
	    padding: 6px 6px 6px 12px; 
	    color: #4f6b72; 
	}
	
	
	.mytable td.alt { 
	    background: #F5FAFA; 
	    color: #797268; 
	}
	
	.mytable th.spec { 
	    border-left: 1px solid #C1DAD7; 
	    border-top: 0; 
	    background: #fff url(images/bullet1.gif) no-repeat; 
	    font: bolder 10px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif, "新宋体";
	}
	
	.mytable th.specalt { 
	    border-left: 1px solid #C1DAD7; 
	    border-top: 0; 
	    background: #f5fafa url(images/bullet2.gif) no-repeat; 
	    font: bold 10px "Trebuchet MS", Verdana, Arial, Helvetica, sans-serif; 
	    color: #797268; 
	} 
</style>
<script type="text/javascript">
	function init(){
		var datatime = new Date();  
		var myYears = ( datatime.getYear() < 1900 ) ? ( 1900 + datatime.getYear() ) : datatime.getYear(); 
		var myMoth= (datatime.getMonth() + 1 )>9 ? (datatime.getMonth() + 1 ) : (datatime.getMonth() + 1 );
		var myDate= datatime.getDate()>9 ? datatime.getDate() : (datatime.getDate());
		var curTime=" "+datatime.getHours()+":"+datatime.getMinutes()+":"+datatime.getSeconds();
		var date = myYears +"-" + myMoth + "-" + myDate+curTime; 
		datatime.setDate(datatime.getDate()-1); 
		var myYears = ( datatime.getYear() < 1900 ) ? ( 1900 + datatime.getYear() ) : datatime.getYear(); 
		var myMoth= (datatime.getMonth() + 1 )>9 ? (datatime.getMonth() + 1 ) : (datatime.getMonth() + 1 );
		var myDate= datatime.getDate()>9 ? datatime.getDate() : (datatime.getDate()); 
		var lastDate =  myYears +"-" + myMoth + "-" + myDate+curTime; 
		datatime.setDate(datatime.getDate()-29); 
		var myYears = ( datatime.getYear() < 1900 ) ? ( 1900 + datatime.getYear() ) : datatime.getYear(); 
		var myMoth= (datatime.getMonth() + 1 )>9 ? (datatime.getMonth() + 1 ) : (datatime.getMonth() + 1 );
		var myDate= datatime.getDate()>9 ? datatime.getDate() : (datatime.getDate()); 
		var lastMoth =  myYears +"-" + myMoth + "-" + myDate+curTime; 
		
		document.getElementById("bgDate").value=lastDate;
		document.getElementById("chartbgDate").value=lastMoth;
		document.getElementById("endDate").value=date;
		document.getElementById("charendDate").value=date;
		
	}
	
	function calTotal(){
		var bgTime=document.getElementById("bgDate").value;
		var endTime=document.getElementById("endDate").value;
		var msg="bg="+document.getElementById("bgDate").value+"&end="+document.getElementById("endDate").value;
		document.getElementById("imgLoading").style.display='';
		document.getElementById("btnSumary").disabled='disabled';
		getdata('../php/Statistic.php',msg,function(xmlHttp){//获取推荐好友的数据
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				var res = eval('(' + xmlHttp.responseText + ')');
				document.getElementById("bgDate").value=res.bg;
				document.getElementById("endDate").value=res.end;
				res=res.res;
				var html_text='<table class="mytable" cellspacing="0" align="center"><tr><th>Name</th><th>Distinct User Num</th><th>Statistic Num</th></tr>';
				for(var i=1;i<res.length;i++){
					html_text+='<tr class="specalt"><td>'+res[i][0]+'</td><td>'+res[i][1]+'</td><td>'+res[i][2]+'</td></tr>';
				}
				html_text+='</table>'
				document.getElementById("sumary_count_div").innerHTML=html_text;
				document.getElementById("imgLoading").style.display='none';
				document.getElementById("btnSumary").disabled='';
			}
		});
		//document.getElementById("lblSumary").innerText="waiting for server calculate...";
	}
	
	function getAndDraw(){
		var thisObj=document.getElementById("selectType");
		var selectedIndex=thisObj.options.selectedIndex;
		var title=thisObj.options[selectedIndex].value;
		var bgTime=document.getElementById("chartbgDate").value;
		var endTime=document.getElementById("charendDate").value;
		var date=(new Date(endTime)).getTime()-(new Date(bgTime)).getTime();
		var day=date/(24*3600*1000);		
		var msg='type='+selectedIndex+'&bg='+bgTime+'&end='+endTime;
		if(day>2)
			msg+='&day=1';
		else 
			msg+='&day=0';
		var interVal= day>2 ? day * 45 : day*24*45;					
		document.getElementById("imgLoading_chart").style.display='';
		document.getElementById("btnDrawLine_chart").disabled='disabled';
		getdata('../php/StatisticChart.php',msg,function(xmlHttp){//获取推荐好友的数据
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				var res = eval('(' + xmlHttp.responseText + ')');
				
				var length=0;
				if(selectedIndex==0)
					length=res.objs.length;
				else if(selectedIndex==1){
					length=Math.max(res.objsUserNum.length,res.objsMsgNum.length);
				}else if(selectedIndex==2){
					length=Math.max(res.objsUserNum.length,res.objsfollowNum.length);
				}else if(selectedIndex==3){
					length=Math.max(res.objsUserNum.length,res.objsletterNum.length);
				}else if(selectedIndex==4){
					length=res.objs.length;
				}else if(selectedIndex==5){
					length=Math.max(res.objsUserNum.length,res.objsCommentNum.length);
				}else if(selectedIndex==6){
					length=Math.max(res.objsUserNum.length,res.objsImageNum.length);
				}else if(selectedIndex==7){
					length=Math.max(res.objsUserNum.length,res.objsEmailNum.length);
				}else if(selectedIndex==8){
					length=Math.max(res.objsUserNum.length,res.objsGroupNum.length);
				}else if(selectedIndex==9){
					length=Math.max(res.objsUserNum.length,res.objsGroupTopicNum.length);
				}else if(selectedIndex==10){
					length=Math.max(res.objsUserNum.length,res.objsGroupTopicReplyNum.length);
				}else if(selectedIndex==11){
					length=Math.max(res.objsUserNum.length,res.objsMsgImg.length);
				}else if(selectedIndex==12){
					length=Math.max(res.objsUserNum.length,res.objsMsgYtub.length);
				}
				
				if(length<=1){
					alert("there has no data ");
					return ;
				}
				var myChart = new JSChart('static_canvas', 'line');
				//myChart.setTitle(title);
				myChart.setSize(interVal, 300);
				if(day>2)
					myChart.setAxisNameX('mm-dd: month and day.');
				else
					myChart.setAxisNameX('dd-hh: day and hour.');
				if (selectedIndex == 0) {//用户增长曲线
					myChart.setDataArray(res.objs);
					for (var i = 0; i < res.objs.length; i++) {
						myChart.setTooltip([res.objs[i][0], res.objs[i][1] + " user increment"]);
					}
					myChart.setTitle(title+"( total:"+res.total+" distinct users )");
				}else if (selectedIndex == 1) {//new message 增长曲线 要画出两天曲线
					//myChart.setDataArray(res.objsUserNum, 'Users send msg');
					
					var tmp_users=new Array();
					var tmp_nums=new Array();
					for(var i=0,j=0;i<res.objsMsgNum.length && j<res.objsMsgNumImg.length;){
						if(res.objsMsgNum[i][0]==res.objsMsgNumImg[j][0]){
							tmp_users.push(res.objsUserNumImg[j]);
							tmp_nums.push(res.objsMsgNumImg[j]);
							i++;j++;continue;
						}else if(res.objsMsgNum[i][0]<res.objsMsgNumImg[j][0]){
							tmp_users.push(new Array(res.objsMsgNum[i][0],0));
							tmp_nums.push(new Array(res.objsMsgNum[i][0],0));
							i++;
						}	
					}
					res.objsMsgNumImg=tmp_nums;
					res.objsUserNumImg=tmp_users;
					
					var tmp_users=new Array();
					var tmp_nums=new Array();
					for(var i=0,j=0;i<res.objsMsgNum.length && j<res.objsMsgNumUtub.length;){
						if(res.objsMsgNum[i][0]==res.objsMsgNumUtub[j][0]){
							tmp_users.push(res.objsUserNumUtub[j]);
							tmp_nums.push(res.objsMsgNumUtub[j]);
							i++;j++;continue;
						}else if(res.objsMsgNum[i][0]<res.objsMsgNumUtub[j][0]){
							tmp_users.push(new Array(res.objsMsgNum[i][0],0));
							tmp_nums.push(new Array(res.objsMsgNum[i][0],0));
							i++;
						}	
					}
					res.objsMsgNumUtub=tmp_nums;
					res.objsUserNumUtub=tmp_users;
					myChart.setDataArray(res.objsMsgNum, 'Msg Num');
					myChart.setDataArray(res.objsMsgNumImg, 'Msg Num Img');
					myChart.setDataArray(res.objsMsgNumUtub, 'Msg Num Utub');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user send "+res.objsMsgNum[i][1]+" msgs.",'Msg Num']);
					}
					for (var i = 0; i < res.objsUserNumImg.length; i++) {
						myChart.setTooltip([res.objsUserNumImg[i][0], res.objsUserNumImg[i][1] + " user send "+res.objsMsgNumImg[i][1]+" Image msgs.",'Msg Num Img']);
					}
					for (var i = 0; i < res.objsUserNumUtub.length; i++) {
						myChart.setTooltip([res.objsUserNumUtub[i][0], res.objsUserNumUtub[i][1] + " user send "+res.objsMsgNumUtub[i][1]+" youtube msgs.",'Msg Num Utub']);
					}
					myChart.setLineWidth(3, 'Msg Num');
					myChart.setLineWidth(2, 'Msg Num Img');
					myChart.setLineColor('#336666', 'Msg Num Img');
					myChart.setLineWidth(2, 'Msg Num Utub');	
					myChart.setLineColor('#6633FF', 'Msg Num Utub');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users send "+res.totalNum+" msg )");
				}else if(selectedIndex == 2){//new follow Num
					myChart.setDataArray(res.objsUserNum, 'Users send msg');
					myChart.setDataArray(res.objsfollowNum, 'Follow Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user add "+res.objsfollowNum[i][1]+" followers.",'Follow Num']);
					}
					myChart.setLineWidth(3, 'Follow Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users add "+res.totalNum+" follows )");
				}else if(selectedIndex == 3){//new letter Num
					myChart.setDataArray(res.objsUserNum, 'Users send msg');
					myChart.setDataArray(res.objsletterNum, 'Letter Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user send "+res.objsletterNum[i][1]+" letters.",'Letter Num']);
					}
					myChart.setLineWidth(3, 'Letter Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users send "+res.totalNum+" private letters )");
				}else if(selectedIndex == 4){//Last login user.
					myChart.setDataArray(res.objs);
					for (var i = 0; i < res.objs.length; i++) {
						myChart.setTooltip([res.objs[i][0], res.objs[i][1] + " user login"]);
					}
					myChart.setTitle(title+"( total:"+res.total+" last login users )");
				}
				else if(selectedIndex == 5){//new Comment Num
					myChart.setDataArray(res.objsUserNum, 'Users Comment');
					myChart.setDataArray(res.objsCommentNum, 'Comment Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user send "+res.objsCommentNum[i][1]+" comments.",'Comment Num']);
					}
					myChart.setLineWidth(3, 'Comment Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users comment "+res.totalNum+" msg )");
				}
				else if(selectedIndex == 6){//new Image NUm
					myChart.setDataArray(res.objsUserNum, 'Users Image');
					myChart.setDataArray(res.objsImageNum, 'Image Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user upload "+res.objsImageNum[i][1]+" images.",'Image Num']);
					}
					myChart.setLineWidth(3, 'Image Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users upload "+res.totalNum+" images )");
				}else if(selectedIndex == 7){//send email
					myChart.setDataArray(res.objsUserNum, 'Users Image');
					myChart.setDataArray(res.objsEmailNum, 'Emailed Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], "send "+res.objsUserNum[i][1] + " user "+res.objsEmailNum[i][1]+" mails.",'Emailed Num']);
					}
					myChart.setLineWidth(3, 'Emailed Num');
					myChart.setTitle(title+"( total:sytem send "+res.totalUser+" distinct users "+res.totalNum+" emails )");
				}else if(selectedIndex == 8){//Group Num
					myChart.setDataArray(res.objsUserNum, 'Users Group');
					myChart.setDataArray(res.objsGroupNum, 'Group Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user create "+res.objsGroupNum[i][1]+" groups.",'Group Num']);
					}
					myChart.setLineWidth(3, 'Group Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users create "+res.totalNum+" groups )");
				}else if(selectedIndex == 9){//Group Topic Num
					myChart.setDataArray(res.objsUserNum, 'Users Group Topic');
					myChart.setDataArray(res.objsGroupTopicNum, 'Group Topic Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user create "+res.objsGroupTopicNum[i][1]+" Topics.",'Group Topic Num']);
					}
					myChart.setLineWidth(3, 'Group Topic Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users lauch "+res.totalNum+" group topics )");
				}else if(selectedIndex == 10){//Group TopicReply Num
					myChart.setDataArray(res.objsUserNum, 'Users Group TopicReply');
					myChart.setDataArray(res.objsGroupTopicReplyNum, 'Group TopicReply Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user Replye "+res.objsGroupTopicReplyNum[i][1]+" Topics.",'Group TopicReply Num']);
					}
					myChart.setLineWidth(3, 'Group TopicReply Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users reply "+res.totalNum+" group topics )");
				}else if(selectedIndex == 11){//new msg img num
					myChart.setDataArray(res.objsUserNum, 'Users MsgImg');
					myChart.setDataArray(res.objsMsgImg, 'MsgImg Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user send "+res.objsMsgImg[i][1]+" msg with img.",'MsgImg Num']);
					}
					myChart.setLineWidth(3, 'MsgImg Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users send "+res.totalNum+" image msg )");
				}else if(selectedIndex == 12){//new msg youtube num
					myChart.setDataArray(res.objsUserNum, 'Users ytubMsg');
					myChart.setDataArray(res.objsMsgYtub, 'ytubMsg Num');
					for (var i = 0; i < res.objsUserNum.length; i++) {
						myChart.setTooltip([res.objsUserNum[i][0], res.objsUserNum[i][1] + " user send "+res.objsMsgYtub[i][1]+" msg with youtube.",'ytubMsg Num']);
					}
					myChart.setLineWidth(3, 'ytubMsg Num');
					myChart.setTitle(title+"( total:"+res.totalUser+" distinct users send "+res.totalNum+" youtube msg )");
				}				
				myChart.draw();
				document.getElementById("imgLoading_chart").style.display='none';
			document.getElementById("btnDrawLine_chart").disabled='';
			}
		});	
	}
	
	function getServerState(){
		getdata('../php/StatisticServerState.php','',function(xmlHttp){
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
				var res = conjsontoarray(xmlHttp.responseText);
				if(res==null)
					return;
				var divhtml='<table class="mytable" cellspacing="0" align="center" style="width:100%;"><th colspan="2">Server State</th>';
				var t1=res[0].date;
				var tmpArray=new Array(res[0]);
				var datatime = new Date();  
				var myYears = ( datatime.getYear() < 1900 ) ? ( 1900 + datatime.getYear() ) : datatime.getYear(); 
				var myMoth= (datatime.getMonth() + 1 )>9 ? (datatime.getMonth() + 1 ) : '0'+(datatime.getMonth() + 1 );
				var myDate= datatime.getDate()>9 ? datatime.getDate() : '0'+(datatime.getDate());
				var dateStr=myYears.toString().substring(2)+"-"+myMoth+"-"+myDate;
				for(var i=1;i<res.length;i++){
					if(t1==res[i].date){
						tmpArray.push(res[i]);
						continue;
					}else{
						if(dateStr==t1)
							divhtml+= tmpArray.length<3 ? ('<tr class="specalt"><td><b><span style="color:#D7DF01;">'+t1+'</span></b>'+'</td><td>') : ('<tr class="specalt"><td><span>'+t1+'</span>'+'</td><td>');
						else
							divhtml+= tmpArray.length<3 ? ('<tr class="specalt"><td><b><span style="color:red;">'+t1+'</span></b>'+'</td><td>') : ('<tr class="specalt"><td><span>'+t1+'</span>'+'</td><td>');
						for(var j=0;j<tmpArray.length;j++){
							divhtml+=tmpArray[j].operType+":"+tmpArray[j].description+"("+tmpArray[j].date+")<br />";
						}
						divhtml+="</td></tr>";
						//clear the tmp Array
						t1=res[i].date;
						var tmpArray=new Array(res[i]);
					}
				}
				//the last one.
				divhtml+= tmpArray.length<3 ? ('<tr class="specalt"><td><b><span style="color:red;">'+t1+'</span></b>'+'</td><td>') : ('<tr class="specalt"><td><span>'+t1+'</span>'+'</td><td>');
				for(var j=0;j<tmpArray.length;j++){
					divhtml+=tmpArray[j].operType+":"+tmpArray[j].description+"("+tmpArray[j].date+")<br />";
				}
				divhtml+="</td></tr>";
				divhtml+='</table>';
				document.getElementById("server_status").innerHTML=divhtml;
			}
		});
	}
	

</script>

</head>
<body onload="init();">
	
				<fieldset>
    	<legend>Statistic (Date-Formate: 2011-06-25)</legend>
		<div id="select area" style="padding:5px 10px">
			 Begin:<input type="date" id="chartbgDate" value="" />&nbsp;&nbsp;
			 End:<input type="date" id="charendDate" value="" />&nbsp;&nbsp;
			 Table:<select id="selectType">
				<option>New Register User Increment</option>
				<option>New Msg Num</option>
				<option>New Follow Num</option>
				<option>New PrivateLetter Num</option>
				<option>Last Login User</option>
				<option>New Comment Num</option>
				<option>New Images Num</option>
				<option>New sended Email</option>
				<option>New Group Num</option>
				<option>New Group Topic Num</option>
				<option>New Group Topic Reply Num</option>
				<option>New Msg Num With Img</option>
				<option>New Msg Num With Youtube</option>
			</select>
			<input id="btnDrawLine_chart" type="button" onclick="getAndDraw();" value="Draw lines">
			 <img id="imgLoading_chart" src="../img/loader.gif" style="width:20px;height:20px;display:none;" alt="loading... " />
			 
		</div>
		<div id="static_canvas">
			
		</div>
	</fieldset>
<div>
	
	
	
		<fieldset>
    	<legend>Statistic (Date-Formate: 2011-06-25)</legend>
	    	<div style="overflow:auto;width:470px;height:100%; float:left;">
					<div id="server_status">
					</div>
			</div>
		<div id="static" style="padding-left:20px;float:left;">
			 <table class="iner">
			                <tr style="height:20px;">
			                    <td>
			                        Begin:
			                        <input type="date" id="bgDate" value="" />
			                    </td>
			                    <td>
			                        End:
			                        <input type="date" id="endDate" value="" />
			                    </td>
			               		<td>
			                        <input id="btnSumary" type="button" value="Sumary" onclick="calTotal();" />
			                        <img id="imgLoading" src="../img/loader.gif" style="width:20px;height:20px;display:none;" alt="loading... " />
			                   
			                    </td>
			                </tr>
			  </table>
			 <div id="sumary_count_div"></div>
		</div>
		</fieldset>
		
	
</div>


	
	
	
	
<script type="text/javascript">
	init();
	getServerState();
	//calTotal();
	getAndDraw();
</script>


</body>
</html>
